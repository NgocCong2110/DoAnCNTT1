<div class="bg-light">
  <app-header-web></app-header-web>

  <div class="container py-5">
    <div *ngIf="chi_tiet" class="row g-4">

      <div class="col-lg-8">
        <div class="card shadow-sm border-0 rounded-4 p-4">
          <div
            class="d-flex flex-column flex-md-row justify-content-between align-items-md-center border-bottom pb-3 mb-4">
            <button *ngIf="auth.layThongTinNguoiDung()?.kieu_nguoi_dung == 'nguoi_Tim_Viec'" class="btn btn-outline-primary fw-semibold px-3 py-2 position-absolute top-0 end-0 m-3"
              (click)="luuViecLam()" style="z-index: 10;">
              <i class="bi bi-bookmark me-1"></i>
              <img src="anh_WEB/anh_icon_WEB/anh_icon_luu_bai.webp" style="width:16px;height:16px;margin-right:5px;">
              Lưu việc làm
            </button>

            <div
              class="d-flex flex-column flex-md-row justify-content-between align-items-md-center border-bottom pb-3 mb-4"
              style="padding-right: 140px;">
              <div>
                <h2 class="fw-bold mb-2 text-dark">{{ chi_tiet?.tieu_de }}</h2>
                <p class="text-secondary mb-1">{{ chi_tiet?.viec_lam?.cong_Ty?.ten_cong_ty }}</p>
                <p class="text-muted mb-0">
                  <i class="bi bi-geo-alt"></i> {{ chi_tiet?.viec_lam?.dia_diem }}
                </p>
              </div>
            </div>

          </div>

          <div class="row text-secondary mb-3">
            <div class="col-6 col-md-3 mb-3" *ngFor="let item of [
              {icon:'bi-briefcase', label:'Ngành nghề', value: laynganhnghe(chi_tiet?.viec_lam?.nganh_nghe)},
              {icon:'bi-person-workspace', label:'Vị trí', value: chi_tiet?.viec_lam?.vi_tri},
              {icon:'bi-cash-coin', label:'Mức lương', value: chi_tiet?.viec_lam?.muc_luong},
              {icon:'bi-clock-history', label:'Cập nhật', value: (chi_tiet?.viec_lam?.ngay_cap_nhat | date:'dd/MM/yyyy')}
            ]">
              <i class="bi {{item.icon}} text-primary me-2"></i>
              <strong>{{item.label}}:</strong>
              <div class="ms-4">{{item.value}}</div>
            </div>
          </div>

          <div class="d-flex justify-content-start align-items-center gap-3 flex-wrap">

            <button *ngIf="auth.layThongTinNguoiDung()?.kieu_nguoi_dung == 'nguoi_Tim_Viec'"
              class="btn btn-primary fw-semibold px-4 py-2 mb-2 w-75" (click)="ungTuyenCongViec()">
              <i class="bi bi-send-fill me-1"></i> Ứng tuyển ngay
            </button>

          </div>



          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Mô tả công việc</h5>
            <p class="text-muted">{{ chi_tiet?.viec_lam?.mo_ta }}</p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Yêu cầu ứng viên</h5>
            <p class="text-muted">{{ chi_tiet?.viec_lam?.yeu_cau }}</p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Trình độ học vấn yêu cầu</h5>
            <p class="text-muted">{{ layTrinhDoHocVan(chi_tiet?.viec_lam?.trinh_do_hoc_van_yeu_cau) }}</p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Quyền lợi công việc</h5>
            <p class="text-muted">{{ chi_tiet?.viec_lam?.quyen_loi_cong_viec }}</p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Hình thức làm việc</h5>
            <p class="text-muted">{{ layLoaiHinh(chi_tiet?.viec_lam?.loai_hinh) }}</p>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Thời gian làm việc</h5>
            <p class="text-muted">{{ chi_tiet?.viec_lam?.thoi_gian_lam_viec }}</p>
          </div>

          <div class="mb-4" *ngIf="chi_tiet?.viec_lam?.danh_sach_phuc_loi?.length > 0">
            <h5 class="fw-semibold text-dark mb-2">Phúc lợi</h5>
            <ul class="list-unstyled text-muted mb-0">
              <li *ngFor="let phuc_loi of chi_tiet.viec_lam.danh_sach_phuc_loi" class="mb-1">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                {{ phuc_loi.ten_phuc_loi }}
              </li>
            </ul>
          </div>

          <div class="mb-4">
            <h5 class="fw-semibold text-dark mb-2">Hạn nộp cv</h5>
            <p class="text-muted">{{ chi_tiet?.viec_lam?.thoi_han_nop_cv }}</p>
          </div>

          <div>
            <h5 class="fw-semibold text-dark mb-2">Thông tin đăng tuyển</h5>
            <p class="text-muted mb-1">Ngày tạo: {{ chi_tiet?.viec_lam?.ngay_tao | date:'dd/MM/yyyy' }}</p>
            <p class="text-muted mb-0">Ngày cập nhật: {{ chi_tiet?.viec_lam?.ngay_cap_nhat | date:'dd/MM/yyyy' }}</p>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="sticky-top">
          <div class="dieuhuongtoitranggioithieu card border-0 shadow-sm rounded-4 p-4 text-center sticky-top"
            (click)="dieuHuongToiTrangGioiThieu(chi_tiet.viec_lam.cong_Ty?.ma_cong_ty)">

            <div class="d-flex justify-content-center">
              <img *ngIf="chi_tiet?.viec_lam?.cong_Ty?.logo" [src]="taoDuongDanLogo(chi_tiet.viec_lam.cong_Ty?.logo)"
                alt="Logo công ty" class="company-logo mb-3 rounded" />
              <img *ngIf="!chi_tiet?.viec_lam?.cong_Ty?.logo" src="assets/default-logo.png" alt="Logo mặc định"
                class="company-logo mb-3 rounded" />
            </div>

            <h4 class="fw-bold text-dark mb-2">{{ chi_tiet?.viec_lam?.cong_Ty?.ten_cong_ty }}</h4>
            <p class="text-muted mb-3">
              <i class="bi bi-geo-alt"></i> {{ chi_tiet?.viec_lam?.dia_diem }}
            </p>
          </div>

          <div class="card card-border-light shadow-sm rounded-4 p-4 mt-4 sticky-top">
            <h5 class="fw-semibold text-dark mb-3 text-center">Việc làm khác tại công ty</h5>

            <div *ngIf="danh_sach_viec_lam_cung_cong_ty?.length > 0; else khongCoViec">
              <div *ngFor="let viec of danh_sach_viec_lam_cung_cong_ty" class="border-bottom pb-3 mb-3">
                <div class="card-job" (click)="dieuHuongToiViecLam(viec)" style="cursor:pointer">
                  <h6 class="fw-bold text-primary mb-1">
                    {{ viec.tieu_de }}
                  </h6>
                  <p class="text-muted small mb-1">
                    <i class="bi bi-geo-alt"></i> {{ viec.cong_Ty?.ten_cong_ty }}
                  </p>
                  <p class="text-muted small mb-0">
                    <i class="bi bi-cash-coin"></i> Mức lương: {{ viec.muc_luong }}
                  </p>
                </div>

              </div>
            </div>

            <ng-template #khongCoViec>
              <p class="text-center text-muted mb-0">Hiện chưa có việc làm nào khác từ công ty này.</p>
            </ng-template>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<div class="modal fade show" tabindex="-1" *ngIf="pop_up_ung_tuyen"
  style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 class="modal-title text-success">Ứng tuyển thành công!</h5>
      <div class="modal-body">
        <p>Bạn đã ứng tuyển vào công việc này.</p>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="pop_up_ung_tuyen=false"></button>
    </div>
  </div>
</div>


<div class="modal fade show" tabindex="-1" *ngIf="pop_up_chon_cv" style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title">Chọn CV để ứng tuyển</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="huyChonCV()"></button>
      </div>

      <div class="modal-body">
        <p>Ứng tuyển vào: <b>{{ chi_tiet?.tieu_de }}</b></p>

        <div class="mb-3">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="chonHeThong" name="loai_cv" value="he_thong" [(ngModel)]="loai_cv">
            <label class="form-check-label" for="chonHeThong">Chọn CV có sẵn trong hệ thống</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" id="chonUpload" name="loai_cv" value="upload" [(ngModel)]="loai_cv">
            <label class="form-check-label" for="chonUpload">Tải CV từ máy (PDF / DOCX)</label>
          </div>
        </div>

        <hr>

        <div *ngIf="loai_cv === 'he_thong'">
          <div *ngIf="danh_sach_cv?.length; else noCVList">
            <ul class="list-group">
              <li *ngFor="let cv of danh_sach_cv" class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ cv.ten_cv }}</div>
                  <small class="text-muted">{{ cv.ho_ten }} • {{ cv.ngay_tao | date:'dd/MM/yyyy' }}</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <a *ngIf="cv.duong_dan_file_pdf" [href]="'http://localhost:65001/' + cv.duong_dan_file_pdf" target="_blank" class="btn btn-sm btn-outline-primary">Xem</a>
                  <input type="radio" name="cv_chon" [value]="cv.ma_cv" [(ngModel)]="cv_duoc_chon">
                </div>
              </li>
            </ul>
          </div>

          <ng-template #noCVList>
            <p class="text-muted">Bạn chưa có CV nào trong hệ thống. Vui lòng tạo CV trước khi chọn.</p>
          </ng-template>
        </div>

        <div *ngIf="loai_cv === 'upload'">
          <label class="form-label">Chọn file CV (PDF, DOCX) — tối đa 5MB</label>
          <input type="file" class="form-control" (change)="chonFile($event)" accept=".pdf">

          <div *ngIf="file_cv_upload" class="mt-2 d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">{{ file_cv_upload.name }}</div>
              <small class="text-muted">Kích thước: {{ (file_cv_upload.size / 1024 / 1024) | number:'1.2-2' }} MB</small>
            </div>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-secondary" type="button" (click)="xemFileTamThoi()">Xem</button>
              <button class="btn btn-sm btn-outline-danger" type="button" (click)="xoaFileDangChon()">Xóa</button>
            </div>
          </div>

          <div *ngIf="!file_cv_upload" class="mt-2 text-muted small">
            Chưa có file được chọn.
          </div>
        </div>

        <hr class="mt-3">
      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-secondary" (click)="huyChonCV()">Huỷ</button>
        <button
          class="btn btn-primary"
          [disabled]="!canSubmit()"
          (click)="ungTuyenCongViec()">
          Ứng tuyển
        </button>
      </div>
    </div>
  </div>
</div>
